<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UML Dashboard EXTREME DEVOPS</title>

<style>
    :root {
        --bg-light: #ffffff;
        --bg-dark: #121212;
        --fg-light: #000000;
        --fg-dark: #e5e5e5;
        --accent: #3498db;
        --accent-soft: #2980b9;
        --sidebar-dark: #1f1f1f;
        --sidebar-light: #f4f4f4;
    }

    body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg-light);
        color: var(--fg-light);
        display: flex;
        height: 100vh;
        overflow: hidden;
        transition: background 0.3s, color 0.3s;
    }

    body.dark {
        background: var(--bg-dark);
        color: var(--fg-dark);
    }

    /* Sidebar */
    #sidebar {
        width: 260px;
        background: var(--sidebar-dark);
        color: #fff;
        height: 100vh;
        overflow-y: auto;
        padding-top: 16px;
        flex-shrink: 0;
        transition: background 0.3s, color 0.3s;
    }
    body.light #sidebar {
        background: var(--sidebar-light);
        color: #000;
    }

    #sidebar h2 {
        text-align: center;
        margin: 0 0 4px 0;
        font-size: 18px;
    }

    #sidebar small {
        display: block;
        text-align: center;
        opacity: 0.8;
        margin-bottom: 8px;
    }

    #searchBox {
        width: 85%;
        margin: 8px auto 12px auto;
        padding: 6px 8px;
        border-radius: 6px;
        border: none;
        font-size: 14px;
        display: block;
        outline: none;
    }

    .uml-group-title {
        padding: 6px 16px;
        font-size: 13px;
        text-transform: uppercase;
        opacity: 0.7;
    }

    .uml-item {
        padding: 8px 18px;
        cursor: pointer;
        font-size: 14px;
        border-left: 3px solid transparent;
        transition: background 0.2s, border-color 0.2s;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .uml-item:hover {
        background: rgba(255,255,255,0.08);
    }
    body.light .uml-item:hover {
        background: rgba(0,0,0,0.06);
    }
    .uml-item.active {
        border-left-color: var(--accent);
        font-weight: 600;
    }

    /* Viewer */
    #viewer {
        flex-grow: 1;
        padding: 0;
        position: relative;
        display: flex;
        flex-direction: column;
        background: radial-gradient(circle at top left, rgba(52,152,219,0.08), transparent 60%);
    }

    #topbar {
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    body.dark #topbar {
        border-bottom-color: rgba(255,255,255,0.08);
    }

    #titleCurrent {
        font-size: 15px;
        font-weight: 600;
    }

    #status {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        margin-left: 8px;
    }
    #status.ws-ok {
        background: #2ecc71;
        color: #fff;
    }
    #status.ws-fail {
        background: #e74c3c;
        color: #fff;
    }

    #toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    button {
        padding: 6px 10px;
        border: none;
        cursor: pointer;
        border-radius: 999px;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #ddd;
    }
    button span {
        font-size: 13px;
    }
    button:hover {
        opacity: 0.85;
    }

    #themeBtn { background: #444; color: #fff; }
    #resetViewBtn { background: #7f8c8d; color: #fff; }
    #exportPNGBtn { background: #2980b9; color: #fff; }
    #exportPDFBtn { background: #c0392b; color: #fff; }

    body.light #themeBtn {
        background: #222;
    }

    /* Canvas zone */
    #canvasWrapper {
        flex: 1;
        overflow: hidden;
        position: relative;
        background: transparent;
    }

    #umlContainer {
        width: 100%;
        height: 100%;
        overflow: auto;
        position: relative;
    }

    img.uml-diagram {
        max-width: 100%;
        max-height: 100%;
        display: block;
        margin: auto;
        cursor: grab;
        transform-origin: center center;
        transition: transform 0.05s linear;
    }

    body.dark img.uml-diagram {
        background: #1e1e1e;
        filter: invert(1) hue-rotate(180deg);
    }

    /* Info overlay (en bas √† droite) */
    #infoOverlay {
        position: absolute;
        right: 10px;
        bottom: 10px;
        background: rgba(0,0,0,0.65);
        color: #fff;
        padding: 4px 8px;
        font-size: 11px;
        border-radius: 999px;
        pointer-events: none;
    }
    body.light #infoOverlay {
        background: rgba(0,0,0,0.5);
    }
</style>
</head>

<body class="light">

<!-- Sidebar -->
<div id="sidebar">
    <h2>üìÅ UML Viewer</h2>
    <small>EXTREME DEVOPS</small>
    <input type="text" id="searchBox" placeholder="Search UML...">

    <div id="umlList">
        <!-- Rempli dynamiquement -->
    </div>
</div>

<!-- Viewer -->
<div id="viewer">
    <div id="topbar">
        <div style="display:flex; align-items:center;">
            <span id="titleCurrent">Aucun diagramme charg√©</span>
            <span id="status" class="ws-fail">WS: OFF</span>
        </div>
        <div id="toolbar">
            <button id="themeBtn"><span>üåô</span><span>Dark</span></button>
            <button id="resetViewBtn"><span>üîÑ</span><span>Reset</span></button>
            <button id="exportPNGBtn"><span>üì∏</span><span>PNG</span></button>
            <button id="exportPDFBtn"><span>üìÑ</span><span>PDF</span></button>
        </div>
    </div>
    <div id="canvasWrapper">
        <div id="umlContainer"></div>
        <div id="infoOverlay">Zoom: 100% ‚Ä¢ Drag: souris ‚Ä¢ Wheel: zoom</div>
    </div>
</div>

<script>
// ===========================
// Config : liste UML (doit refl√©ter tes fichiers)
// ===========================
const UML_GROUPS = [
    {
        label: "Architecture",
        items: [
            { file: "uml_architecture.svg", label: "Architecture globale" },
            { file: "uml_queue.svg",        label: "Queue FIFO" },
            { file: "uml_threads.svg",      label: "Threads & Workers" }
        ]
    },
    {
        label: "TCP",
        items: [
            { file: "uml_seq_tcp_monothread.svg",   label: "TCP Mono-thread" },
            { file: "uml_seq_tcp_multithread.svg",  label: "TCP Multi-thread" }
        ]
    },
    {
        label: "HTTP",
        items: [
            { file: "uml_seq_http_monothread.svg",  label: "HTTP Mono-thread" },
            { file: "uml_seq_http_multithread.svg", label: "HTTP Multi-thread" }
        ]
    }
];

const WS_URL = "ws://localhost:8765";

const listDiv = document.getElementById("umlList");
const container = document.getElementById("umlContainer");
const titleCurrent = document.getElementById("titleCurrent");
const statusBadge = document.getElementById("status");

let currentFile = null;
let currentScale = 1.0;
let originX = 0;
let originY = 0;

// ===========================
// Construction du menu UML
// ===========================
function buildUmlList() {
    listDiv.innerHTML = "";
    UML_GROUPS.forEach(group => {
        const gt = document.createElement("div");
        gt.className = "uml-group-title";
        gt.textContent = group.label;
        listDiv.appendChild(gt);

        group.items.forEach(item => {
            const div = document.createElement("div");
            div.className = "uml-item";
            div.dataset.file = item.file;
            div.textContent = item.label;
            div.onclick = () => loadDiagram(item.file, item.label);
            listDiv.appendChild(div);
        });
    });
}

function setActiveItem(file) {
    document.querySelectorAll(".uml-item").forEach(item => {
        item.classList.toggle("active", item.dataset.file === file);
    });
}

// ===========================
// Chargement d'un diagramme
// ===========================
function loadDiagram(filename, label) {
    currentFile = filename;
    titleCurrent.textContent = label || filename;
    setActiveItem(filename);

    container.innerHTML = "";
    const img = document.createElement("img");
    img.className = "uml-diagram";
    img.id = "umlImg";
    img.setAttribute("data-src", filename);
    img.src = filename + "?t=" + Date.now(); // cache-buster
    container.appendChild(img);

    // Reset zoom/drag
    currentScale = 1.0;
    originX = 0;
    originY = 0;
    applyTransform();

    enableZoomAndDrag(img);
}

// ===========================
// Recherche
// ===========================
document.getElementById("searchBox").addEventListener("input", function () {
    const val = this.value.toLowerCase();
    document.querySelectorAll(".uml-item").forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(val) ? "block" : "none";
    });
});

// ===========================
// Th√®me Dark / Light
// ===========================
document.getElementById("themeBtn").onclick = () => {
    const body = document.body;
    body.classList.toggle("dark");
    body.classList.toggle("light");

    const btn = document.getElementById("themeBtn");
    if (body.classList.contains("dark")) {
        btn.innerHTML = "<span>‚òÄÔ∏è</span><span>Light</span>";
    } else {
        btn.innerHTML = "<span>üåô</span><span>Dark</span>";
    }
};

// ===========================
// Zoom + Drag
// ===========================
function applyTransform() {
    const img = document.getElementById("umlImg");
    if (!img) return;
    img.style.transform = `scale(${currentScale}) translate(${originX}px, ${originY}px)`;
    const info = document.getElementById("infoOverlay");
    info.textContent = `Zoom: ${(currentScale * 100).toFixed(0)}% ‚Ä¢ Drag: souris ‚Ä¢ Wheel: zoom`;
}

function enableZoomAndDrag(img) {
    let isDragging = false;
    let lastX = 0;
    let lastY = 0;

    img.onwheel = e => {
        e.preventDefault();
        const delta = e.deltaY < 0 ? 0.1 : -0.1;
        currentScale = Math.min(5, Math.max(0.3, currentScale + delta));
        applyTransform();
    };

    img.onmousedown = e => {
        isDragging = true;
        lastX = e.clientX;
        lastY = e.clientY;
        img.style.cursor = "grabbing";
    };
    img.onmouseup = () => {
        isDragging = false;
        img.style.cursor = "grab";
    };
    img.onmouseleave = () => {
        isDragging = false;
        img.style.cursor = "grab";
    };
    img.onmousemove = e => {
        if (!isDragging) return;
        originX += (e.clientX - lastX) / currentScale;
        originY += (e.clientY - lastY) / currentScale;
        lastX = e.clientX;
        lastY = e.clientY;
        applyTransform();
    };
}

// Reset view
document.getElementById("resetViewBtn").onclick = () => {
    currentScale = 1.0;
    originX = 0;
    originY = 0;
    applyTransform();
};

// ===========================
// Export PNG / PDF
// ===========================
document.getElementById("exportPNGBtn").onclick = () => {
    const img = document.getElementById("umlImg");
    if (!img) return;
    const link = document.createElement("a");
    const base = img.getAttribute("data-src") || img.src;
    link.download = (base || "uml_diagram").replace(".svg", ".png");
    link.href = base;  // On suppose que tu as aussi des PNG si besoin
    link.click();
};

document.getElementById("exportPDFBtn").onclick = () => {
    window.print();
};

// ===========================
// WebSocket : EXTREME DEVOPS
// ===========================
let ws = null;

function setWsStatus(ok) {
    if (ok) {
        statusBadge.classList.remove("ws-fail");
        statusBadge.classList.add("ws-ok");
        statusBadge.textContent = "WS: ON";
    } else {
        statusBadge.classList.remove("ws-ok");
        statusBadge.classList.add("ws-fail");
        statusBadge.textContent = "WS: OFF";
    }
}

function connectWS() {
    try {
        ws = new WebSocket(WS_URL);
    } catch (e) {
        console.warn("WS error at connect:", e);
        setWsStatus(false);
        return;
    }

    ws.onopen = () => {
        console.log("[WS] Connected");
        setWsStatus(true);
    };

    ws.onclose = () => {
        console.log("[WS] Closed, retry in 2s");
        setWsStatus(false);
        setTimeout(connectWS, 2000);
    };

    ws.onerror = (e) => {
        console.log("[WS] Error:", e);
        setWsStatus(false);
    };

    ws.onmessage = (ev) => {
        console.log("[WS] Message:", ev.data);
        if (ev.data.startsWith("reload")) {
            // Format : "reload" ou "reload:filename.svg"
            const parts = ev.data.split(":");
            const target = (parts.length > 1) ? parts[1] : null;
            reloadCurrentDiagram(target);
        }
    };
}

function reloadCurrentDiagram(targetFile) {
    const img = document.getElementById("umlImg");
    if (!img) return;

    // Si un fichier est mentionn√© et qu'il ne correspond pas au diagramme courant,
    // on ne recharge que si c'est le m√™me.
    if (targetFile && currentFile && targetFile !== currentFile) {
        return;
    }

    const base = img.getAttribute("data-src") || currentFile;
    if (!base) return;
    img.src = base + "?t=" + Date.now();
    console.log("[UML] Reload image:", base);
}

// ===========================
// Init
// ===========================
buildUmlList();
// Charge par d√©faut le premier de la liste si pr√©sent
if (UML_GROUPS.length > 0 && UML_GROUPS[0].items.length > 0) {
    const first = UML_GROUPS[0].items[0];
    loadDiagram(first.file, first.label);
}
connectWS();
</script>

</body>
</html>

